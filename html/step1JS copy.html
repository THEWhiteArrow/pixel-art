<script>
   
   
  let fileInput = document.getElementById('fileInput')
  let widthInput = document.getElementById('widthInput')
  let resolutionInput = document.getElementById('resolutionInput')

  const manageFR = () => {
    const file = fileInput.files[0]  
    const fr = new FileReader
    fr.onload = function () { 
        const url = fr.result
        const shrinkingWidth = widthInput.value || 256
        const res = resolutionInput.value || 1
        createCtx(url,shrinkingWidth,res)
        fileInput.remove()

        setTimeout( () => {

            const f = document.createElement('input')
            f.type="file"
            f.id="fileInput"
            document.body.prepend(f)
            fileInput = document.getElementById('fileInput')
            fileInput.addEventListener('change',manageFR)
        },1000)
    }
      
    fr.readAsDataURL(file)
  }

  const createCtx = (url, shrinkingWidth,res) => {
    document.querySelectorAll('canvas').forEach(el=>el.remove())
    const canvas = document.createElement('canvas')
    
    document.body.append(canvas) 

    const c = document.querySelector('canvas')
    const ctx = c.getContext('2d')

    
    const img = new Image() 
    img.onload = async function () {
        console.log('image loaded...')
        c.width=img.width
        c.height=img.height 
        ctx.clearRect(0,0, c.width, c.height);
        ctx.drawImage(img, 0,0, c.width, c.height);
        
        const array = prepareDimensionalArray(
            ctx.getImageData(0,0,img.width,img.height).data,
            c.width,
            c.height
        )
        c.remove()
        console.log('prepared dimensional array...')
            
            
        console.log(shrinkingWidth)
        const shrankArray = shrinkDimensionalArray(array,shrinkingWidth)
        console.log('shrank dimensional array...')

        
        // console.log('started paii process...')
        // createPAII(array)
        
        console.log('started paii process on a shrank array...')
        createPAII(shrankArray,res) 
      
        
        console.log('finished...')
        console.log('sending to gas...')
        gsr('pixelArt',{data:shrankArray,width:shrankArray[0]?.length,height:shrankArray.length,resolution:res})
        // const data = await gsr('pixelArt',{data:shrankArray,width:shrankArray[0]?.length,height:shrankArray.length,resolution:res})
        // console.log(data)
        // createPAII(data,res)
    }
    img.src=url
    
  }

  const shrinkDimensionalArray = (arr, limit) => {
    if(limit<10) throw new Error('The limit of shrank array is too low.')
    const height = Math.floor(arr.length/2)*2 , width = Math.floor(arr[0]?.length/2)*2
    if(height<=limit && width<=limit) return arr

    let newArr = []
    for(let j=0; j<height;j+=2){
        let row = []
        for(let i=0;i<width;i+=2){
            row.push( avgV2(
                arr[j][i],
                arr[j][i+1],
                arr[j+1][i],
                arr[j+1][i+1]
            ) )
        }
        newArr.push(row)
    }
    if( height/2 <= limit && width/2 <=limit) return newArr
    else return shrinkDimensionalArray(newArr,limit)
  }

  const avgV2 = (...arrays) => arrays
        .reduce( (prev,arr) => arr.map( (el,index) => Math.floor(el+prev[index])  ) )
        .map( el => Math.floor(el/arrays.length) )
  




  const prepareDimensionalArray = (data,width,height)=>{
    let arr = [], counter=0
    for(let h=1;h<=height;++h){
        let row=[]
        for(let w=1;w<=width;++w){
            row.push([
                data[counter++],                
                data[counter++],                
                data[counter++],                
                data[counter++],                
            ])
        }
        arr.push(row)
    }
    return arr
  }


    
  const createPAII = (arr,res=1) => {
    let html = ''
    console.log('i am here')
    for(let j=0;j<arr.length;++j){
        html+=`<div style="display:flex;">`
        for(let i=0;i<arr[j].length;++i){
            let color = `rgba(${arr[j][i][0]},${arr[j][i][1]},${arr[j][i][2]},${arr[j][i][3]})`
            color == 'rgba(0,0,0,0)' ? color='rgba(255,0,0,255)' : null
            html+=`
            <span style=" width:${res}px;height:${res}px;background-color:${color};"></span>
            `
        }
        html+=`</div>`
    }
    document.body.innerHTML+=html
  }

  fileInput.addEventListener('input',manageFR)
</script>
